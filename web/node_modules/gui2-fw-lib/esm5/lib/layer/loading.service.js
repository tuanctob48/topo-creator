/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
/*
 *  Copyright 2018-present Open Networking Foundation
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */
import { Inject, Injectable } from '@angular/core';
import { FnService } from '../util/fn.service';
import { LogService } from '../log.service';
import { ThemeService } from '../util/theme.service';
import * as d3 from 'd3';
import * as i0 from "@angular/core";
import * as i1 from "../util/fn.service";
import * as i2 from "../log.service";
import * as i3 from "../util/theme.service";
/** @type {?} */
var id = 'loading-anim';
/** @type {?} */
var dir = 'data/img/loading/';
/** @type {?} */
var pfx = '/load-';
/** @type {?} */
var nImgs = 16;
/** @type {?} */
var speed = 100;
/** @type {?} */
var waitDelay = 500;
/**
 * ONOS GUI -- Layer -- Loading Service
 *
 * Provides a mechanism to start/stop the loading animation, center screen.
 */
var LoadingService = /** @class */ (function () {
    function LoadingService(fs, log, ts, w) {
        this.fs = fs;
        this.log = log;
        this.ts = ts;
        this.w = w;
        this.images = [];
        this.idx = 0;
        this.preloadImages();
        this.log.debug('LoadingService constructed');
    }
    /**
     * @param {...?} args
     * @return {?}
     */
    LoadingService.prototype.dbg = /**
     * @param {...?} args
     * @return {?}
     */
    function () {
        var args = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            args[_i] = arguments[_i];
        }
        this.fs.debug(this.constructor.name, args);
    };
    /**
     * @return {?}
     */
    LoadingService.prototype.preloadImages = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var idx;
        this.dbg('preload images start...');
        for (idx = 1; idx <= nImgs; idx++) {
            this.addImg('light', idx);
            this.addImg('dark', idx);
        }
        this.dbg('preload images DONE!', this.images);
    };
    /**
     * @param {?} theme
     * @param {?} idx
     * @return {?}
     */
    LoadingService.prototype.addImg = /**
     * @param {?} theme
     * @param {?} idx
     * @return {?}
     */
    function (theme, idx) {
        /** @type {?} */
        var img = new Image();
        img.src = this.fname(idx, theme);
        this.images.push(img);
    };
    /**
     * @param {?} i
     * @param {?} theme
     * @return {?}
     */
    LoadingService.prototype.fname = /**
     * @param {?} i
     * @param {?} theme
     * @return {?}
     */
    function (i, theme) {
        /** @type {?} */
        var z = i > 9 ? '' : '0';
        return dir + theme + pfx + z + i + '.png';
    };
    /**
     * @return {?}
     */
    LoadingService.prototype.nextFrame = /**
     * @return {?}
     */
    function () {
        this.idx = this.idx === 16 ? 1 : this.idx + 1;
        this.img.attr('src', this.fname(this.idx, this.theme));
    };
    // start displaying 'loading...' animation (idempotent)
    // start displaying 'loading...' animation (idempotent)
    /**
     * @return {?}
     */
    LoadingService.prototype.startAnim = 
    // start displaying 'loading...' animation (idempotent)
    /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.dbg('start ANIMATION');
        this.theme = this.ts.getTheme();
        /** @type {?} */
        var div = d3.select('#' + id);
        if (div.empty()) {
            div = d3.select('body')
                .append('div')
                .attr('id', id);
            this.img = div
                .append('img')
                .attr('src', this.fname(1, this.theme));
            this.idx = 1;
            this.task = setInterval(function () { return _this.nextFrame(); }, speed);
        }
    };
    // stop displaying 'loading...' animation (idempotent)
    // stop displaying 'loading...' animation (idempotent)
    /**
     * @return {?}
     */
    LoadingService.prototype.stopAnim = 
    // stop displaying 'loading...' animation (idempotent)
    /**
     * @return {?}
     */
    function () {
        this.dbg('*stop* ANIMATION');
        if (this.task) {
            clearInterval(this.task);
            this.task = null;
        }
        d3.select('#' + id).remove();
    };
    // schedule function to start animation in the future
    // schedule function to start animation in the future
    /**
     * @return {?}
     */
    LoadingService.prototype.start = 
    // schedule function to start animation in the future
    /**
     * @return {?}
     */
    function () {
        this.dbg('start (schedule)');
        this.wait = this.w.setTimeout(this.startAnim(), waitDelay);
    };
    // cancel future start, if any; stop the animation
    // cancel future start, if any; stop the animation
    /**
     * @return {?}
     */
    LoadingService.prototype.stop = 
    // cancel future start, if any; stop the animation
    /**
     * @return {?}
     */
    function () {
        if (this.wait) {
            this.dbg('start CANCELED');
            clearTimeout(this.wait);
            this.wait = null;
        }
        this.stopAnim();
    };
    // return true if start() has been called but not stop()
    // return true if start() has been called but not stop()
    /**
     * @return {?}
     */
    LoadingService.prototype.waiting = 
    // return true if start() has been called but not stop()
    /**
     * @return {?}
     */
    function () {
        return !!this.wait;
    };
    LoadingService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root',
                },] },
    ];
    /** @nocollapse */
    LoadingService.ctorParameters = function () { return [
        { type: FnService },
        { type: LogService },
        { type: ThemeService },
        { type: undefined, decorators: [{ type: Inject, args: ['Window',] }] }
    ]; };
    /** @nocollapse */ LoadingService.ngInjectableDef = i0.defineInjectable({ factory: function LoadingService_Factory() { return new LoadingService(i0.inject(i1.FnService), i0.inject(i2.LogService), i0.inject(i3.ThemeService), i0.inject("Window")); }, token: LoadingService, providedIn: "root" });
    return LoadingService;
}());
export { LoadingService };
if (false) {
    /** @type {?} */
    LoadingService.prototype.images;
    /** @type {?} */
    LoadingService.prototype.idx;
    /** @type {?} */
    LoadingService.prototype.img;
    /** @type {?} */
    LoadingService.prototype.theme;
    /** @type {?} */
    LoadingService.prototype.task;
    /** @type {?} */
    LoadingService.prototype.wait;
    /** @type {?} */
    LoadingService.prototype.fs;
    /** @type {?} */
    LoadingService.prototype.log;
    /** @type {?} */
    LoadingService.prototype.ts;
    /** @type {?} */
    LoadingService.prototype.w;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGluZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vZ3VpMi1mdy1saWIvIiwic291cmNlcyI6WyJsaWIvbGF5ZXIvbG9hZGluZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFlQSxPQUFPLEVBQUMsTUFBTSxFQUFFLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNqRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDL0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNyRCxPQUFPLEtBQUssRUFBRSxNQUFNLElBQUksQ0FBQzs7Ozs7O0lBRW5CLEVBQUUsR0FBRyxjQUFjOztJQUNuQixHQUFHLEdBQUcsbUJBQW1COztJQUN6QixHQUFHLEdBQUcsUUFBUTs7SUFDZCxLQUFLLEdBQUcsRUFBRTs7SUFDVixLQUFLLEdBQUcsR0FBRzs7SUFDWCxTQUFTLEdBQUcsR0FBRzs7Ozs7O0FBUXJCO0lBV0ksd0JBQ1ksRUFBYSxFQUNiLEdBQWUsRUFDZixFQUFnQixFQUNFLENBQU07UUFIeEIsT0FBRSxHQUFGLEVBQUUsQ0FBVztRQUNiLFFBQUcsR0FBSCxHQUFHLENBQVk7UUFDZixPQUFFLEdBQUYsRUFBRSxDQUFjO1FBQ0UsTUFBQyxHQUFELENBQUMsQ0FBSztRQVhwQyxXQUFNLEdBQVUsRUFBRSxDQUFDO1FBQ25CLFFBQUcsR0FBRyxDQUFDLENBQUM7UUFZSixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsNEJBQTRCLENBQUMsQ0FBQztJQUNqRCxDQUFDOzs7OztJQUVELDRCQUFHOzs7O0lBQUg7UUFBSSxjQUFPO2FBQVAsVUFBTyxFQUFQLHFCQUFPLEVBQVAsSUFBTztZQUFQLHlCQUFPOztRQUNQLElBQUks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OEJBQVU7O0lBQ1YsOEJBQWE7O0lBR1QsNEJBQXFCOztJQUNyQiw2QkFBdUI7O0lBQ3ZCLDRCQUF3Qjs7SUFDeEIsMkJBQWdDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqICBDb3B5cmlnaHQgMjAxOC1wcmVzZW50IE9wZW4gTmV0d29ya2luZyBGb3VuZGF0aW9uXG4gKlxuICogIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiAgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqICBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiAgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5pbXBvcnQge0luamVjdCwgSW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGblNlcnZpY2UgfSBmcm9tICcuLi91dGlsL2ZuLnNlcnZpY2UnO1xuaW1wb3J0IHsgTG9nU2VydmljZSB9IGZyb20gJy4uL2xvZy5zZXJ2aWNlJztcbmltcG9ydCB7IFRoZW1lU2VydmljZSB9IGZyb20gJy4uL3V0aWwvdGhlbWUuc2VydmljZSc7XG5pbXBvcnQgKiBhcyBkMyBmcm9tICdkMyc7XG5cbmNvbnN0IGlkID0gJ2xvYWRpbmctYW5pbSc7XG5jb25zdCBkaXIgPSAnZGF0YS9pbWcvbG9hZGluZy8nO1xuY29uc3QgcGZ4ID0gJy9sb2FkLSc7XG5jb25zdCBuSW1ncyA9IDE2O1xuY29uc3Qgc3BlZWQgPSAxMDA7XG5jb25zdCB3YWl0RGVsYXkgPSA1MDA7XG5cblxuLyoqXG4gKiBPTk9TIEdVSSAtLSBMYXllciAtLSBMb2FkaW5nIFNlcnZpY2VcbiAqXG4gKiBQcm92aWRlcyBhIG1lY2hhbmlzbSB0byBzdGFydC9zdG9wIHRoZSBsb2FkaW5nIGFuaW1hdGlvbiwgY2VudGVyIHNjcmVlbi5cbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIExvYWRpbmdTZXJ2aWNlIHtcbiAgICBpbWFnZXM6IGFueVtdID0gW107XG4gICAgaWR4ID0gMDtcbiAgICBpbWc6IGFueTtcbiAgICB0aGVtZTogc3RyaW5nO1xuICAgIHRhc2s6IGFueTtcbiAgICB3YWl0OiBudW1iZXI7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBmczogRm5TZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGxvZzogTG9nU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSB0czogVGhlbWVTZXJ2aWNlLFxuICAgICAgICBASW5qZWN0KCdXaW5kb3cnKSBwcml2YXRlIHc6IGFueVxuICAgICkge1xuICAgICAgICB0aGlzLnByZWxvYWRJbWFnZXMoKTtcbiAgICAgICAgdGhpcy5sb2cuZGVidWcoJ0xvYWRpbmdTZXJ2aWNlIGNvbnN0cnVjdGVkJyk7XG4gICAgfVxuXG4gICAgZGJnKC4uLmFyZ3MpIHtcbiAgICAgICAgdGhpcy5mcy5kZWJ1Zyh0aGlzLmNvbnN0cnVjdG9yLm5hbWUsIGFyZ3MpO1xuICAgIH1cblxuICAgIHByZWxvYWRJbWFnZXMoKSB7XG4gICAgICAgIGxldCBpZHg6IG51bWJlcjtcblxuICAgICAgICB0aGlzLmRiZygncHJlbG9hZCBpbWFnZXMgc3RhcnQuLi4nKTtcbiAgICAgICAgZm9yIChpZHggPSAxOyBpZHggPD0gbkltZ3MgOyBpZHgrKykge1xuICAgICAgICAgICAgdGhpcy5hZGRJbWcoJ2xpZ2h0JywgaWR4KTtcbiAgICAgICAgICAgIHRoaXMuYWRkSW1nKCdkYXJrJywgaWR4KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmRiZygncHJlbG9hZCBpbWFnZXMgRE9ORSEnLCB0aGlzLmltYWdlcyk7XG4gICAgfVxuXG4gICAgYWRkSW1nKHRoZW1lOiBzdHJpbmcsIGlkeDogbnVtYmVyKSB7XG4gICAgICAgIGNvbnN0IGltZyA9IG5ldyBJbWFnZSgpO1xuICAgICAgICBpbWcuc3JjID0gdGhpcy5mbmFtZShpZHgsIHRoZW1lKTtcbiAgICAgICAgdGhpcy5pbWFnZXMucHVzaChpbWcpO1xuICAgIH1cblxuICAgIGZuYW1lKGk6IG51bWJlciwgdGhlbWU6IHN0cmluZykge1xuICAgICAgICBjb25zdCB6ID0gaSA+IDkgPyAnJyA6ICcwJztcbiAgICAgICAgcmV0dXJuIGRpciArIHRoZW1lICsgcGZ4ICsgeiArIGkgKyAnLnBuZyc7XG4gICAgfVxuXG4gICAgbmV4dEZyYW1lKCkge1xuICAgICAgICB0aGlzLmlkeCA9IHRoaXMuaWR4ID09PSAxNiA/IDEgOiB0aGlzLmlkeCArIDE7XG4gICAgICAgIHRoaXMuaW1nLmF0dHIoJ3NyYycsIHRoaXMuZm5hbWUodGhpcy5pZHgsIHRoaXMudGhlbWUpKTtcbiAgICB9XG5cbiAgICAvLyBzdGFydCBkaXNwbGF5aW5nICdsb2FkaW5nLi4uJyBhbmltYXRpb24gKGlkZW1wb3RlbnQpXG4gICAgc3RhcnRBbmltKCkge1xuICAgICAgICB0aGlzLmRiZygnc3RhcnQgQU5JTUFUSU9OJyk7XG4gICAgICAgIHRoaXMudGhlbWUgPSB0aGlzLnRzLmdldFRoZW1lKCk7XG4gICAgICAgIGxldCBkaXYgPSBkMy5zZWxlY3QoJyMnICsgaWQpO1xuICAgICAgICBpZiAoZGl2LmVtcHR5KCkpIHtcbiAgICAgICAgICAgIGRpdiA9IGQzLnNlbGVjdCgnYm9keScpXG4gICAgICAgICAgICAgICAgLmFwcGVuZCgnZGl2JylcbiAgICAgICAgICAgICAgICAuYXR0cignaWQnLCBpZCk7XG4gICAgICAgICAgICB0aGlzLmltZyA9IGRpdlxuICAgICAgICAgICAgICAgIC5hcHBlbmQoJ2ltZycpXG4gICAgICAgICAgICAgICAgLmF0dHIoJ3NyYycsIHRoaXMuZm5hbWUoMSwgdGhpcy50aGVtZSkpO1xuICAgICAgICAgICAgdGhpcy5pZHggPSAxO1xuICAgICAgICAgICAgdGhpcy50YXNrID0gc2V0SW50ZXJ2YWwoKCkgPT4gdGhpcy5uZXh0RnJhbWUoKSwgc3BlZWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gc3RvcCBkaXNwbGF5aW5nICdsb2FkaW5nLi4uJyBhbmltYXRpb24gKGlkZW1wb3RlbnQpXG4gICAgc3RvcEFuaW0oKSB7XG4gICAgICAgIHRoaXMuZGJnKCcqc3RvcCogQU5JTUFUSU9OJyk7XG4gICAgICAgIGlmICh0aGlzLnRhc2spIHtcbiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy50YXNrKTtcbiAgICAgICAgICAgIHRoaXMudGFzayA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgZDMuc2VsZWN0KCcjJyArIGlkKS5yZW1vdmUoKTtcbiAgICB9XG5cbiAgICAvLyBzY2hlZHVsZSBmdW5jdGlvbiB0byBzdGFydCBhbmltYXRpb24gaW4gdGhlIGZ1dHVyZVxuICAgIHN0YXJ0KCkge1xuICAgICAgICB0aGlzLmRiZygnc3RhcnQgKHNjaGVkdWxlKScpO1xuICAgICAgICB0aGlzLndhaXQgPSB0aGlzLncuc2V0VGltZW91dCh0aGlzLnN0YXJ0QW5pbSgpLCB3YWl0RGVsYXkpO1xuICAgIH1cblxuICAgIC8vIGNhbmNlbCBmdXR1cmUgc3RhcnQsIGlmIGFueTsgc3RvcCB0aGUgYW5pbWF0aW9uXG4gICAgc3RvcCgpIHtcbiAgICAgICAgaWYgKHRoaXMud2FpdCkge1xuICAgICAgICAgICAgdGhpcy5kYmcoJ3N0YXJ0IENBTkNFTEVEJyk7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy53YWl0KTtcbiAgICAgICAgICAgIHRoaXMud2FpdCA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zdG9wQW5pbSgpO1xuICAgIH1cblxuICAgIC8vIHJldHVybiB0cnVlIGlmIHN0YXJ0KCkgaGFzIGJlZW4gY2FsbGVkIGJ1dCBub3Qgc3RvcCgpXG4gICAgd2FpdGluZygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICEhdGhpcy53YWl0O1xuICAgIH1cblxuXG59XG4iXX0=