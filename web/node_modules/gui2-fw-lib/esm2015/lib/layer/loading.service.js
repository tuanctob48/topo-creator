/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
/*
 *  Copyright 2018-present Open Networking Foundation
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */
import { Inject, Injectable } from '@angular/core';
import { FnService } from '../util/fn.service';
import { LogService } from '../log.service';
import { ThemeService } from '../util/theme.service';
import * as d3 from 'd3';
import * as i0 from "@angular/core";
import * as i1 from "../util/fn.service";
import * as i2 from "../log.service";
import * as i3 from "../util/theme.service";
/** @type {?} */
const id = 'loading-anim';
/** @type {?} */
const dir = 'data/img/loading/';
/** @type {?} */
const pfx = '/load-';
/** @type {?} */
const nImgs = 16;
/** @type {?} */
const speed = 100;
/** @type {?} */
const waitDelay = 500;
/**
 * ONOS GUI -- Layer -- Loading Service
 *
 * Provides a mechanism to start/stop the loading animation, center screen.
 */
export class LoadingService {
    /**
     * @param {?} fs
     * @param {?} log
     * @param {?} ts
     * @param {?} w
     */
    constructor(fs, log, ts, w) {
        this.fs = fs;
        this.log = log;
        this.ts = ts;
        this.w = w;
        this.images = [];
        this.idx = 0;
        this.preloadImages();
        this.log.debug('LoadingService constructed');
    }
    /**
     * @param {...?} args
     * @return {?}
     */
    dbg(...args) {
        this.fs.debug(this.constructor.name, args);
    }
    /**
     * @return {?}
     */
    preloadImages() {
        /** @type {?} */
        let idx;
        this.dbg('preload images start...');
        for (idx = 1; idx <= nImgs; idx++) {
            this.addImg('light', idx);
            this.addImg('dark', idx);
        }
        this.dbg('preload images DONE!', this.images);
    }
    /**
     * @param {?} theme
     * @param {?} idx
     * @return {?}
     */
    addImg(theme, idx) {
        /** @type {?} */
        const img = new Image();
        img.src = this.fname(idx, theme);
        this.images.push(img);
    }
    /**
     * @param {?} i
     * @param {?} theme
     * @return {?}
     */
    fname(i, theme) {
        /** @type {?} */
        const z = i > 9 ? '' : '0';
        return dir + theme + pfx + z + i + '.png';
    }
    /**
     * @return {?}
     */
    nextFrame() {
        this.idx = this.idx === 16 ? 1 : this.idx + 1;
        this.img.attr('src', this.fname(this.idx, this.theme));
    }
    // start displaying 'loading...' animation (idempotent)
    /**
     * @return {?}
     */
    startAnim() {
        this.dbg('start ANIMATION');
        this.theme = this.ts.getTheme();
        /** @type {?} */
        let div = d3.select('#' + id);
        if (div.empty()) {
            div = d3.select('body')
                .append('div')
                .attr('id', id);
            this.img = div
                .append('img')
                .attr('src', this.fname(1, this.theme));
            this.idx = 1;
            this.task = setInterval(() => this.nextFrame(), speed);
        }
    }
    // stop displaying 'loading...' animation (idempotent)
    /**
     * @return {?}
     */
    stopAnim() {
        this.dbg('*stop* ANIMATION');
        if (this.task) {
            clearInterval(this.task);
            this.task = null;
        }
        d3.select('#' + id).remove();
    }
    // schedule function to start animation in the future
    /**
     * @return {?}
     */
    start() {
        this.dbg('start (schedule)');
        this.wait = this.w.setTimeout(this.startAnim(), waitDelay);
    }
    // cancel future start, if any; stop the animation
    /**
     * @return {?}
     */
    stop() {
        if (this.wait) {
            this.dbg('start CANCELED');
            clearTimeout(this.wait);
            this.wait = null;
        }
        this.stopAnim();
    }
    // return true if start() has been called but not stop()
    /**
     * @return {?}
     */
    waiting() {
        return !!this.wait;
    }
}
LoadingService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] },
];
/** @nocollapse */
LoadingService.ctorParameters = () => [
    { type: FnService },
    { type: LogService },
    { type: ThemeService },
    { type: undefined, decorators: [{ type: Inject, args: ['Window',] }] }
];
/** @nocollapse */ LoadingService.ngInjectableDef = i0.defineInjectable({ factory: function LoadingService_Factory() { return new LoadingService(i0.inject(i1.FnService), i0.inject(i2.LogService), i0.inject(i3.ThemeService), i0.inject("Window")); }, token: LoadingService, providedIn: "root" });
if (false) {
    /** @type {?} */
    LoadingService.prototype.images;
    /** @type {?} */
    LoadingService.prototype.idx;
    /** @type {?} */
    LoadingService.prototype.img;
    /** @type {?} */
    LoadingService.prototype.theme;
    /** @type {?} */
    LoadingService.prototype.task;
    /** @type {?} */
    LoadingService.prototype.wait;
    /** @type {?} */
    LoadingService.prototype.fs;
    /** @type {?} */
    LoadingService.prototype.log;
    /** @type {?} */
    LoadingService.prototype.ts;
    /** @type {?} */
    LoadingService.prototype.w;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGluZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vZ3VpMi1mdy1saWIvIiwic291cmNlcyI6WyJsaWIvbGF5ZXIvbG9hZGluZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFlQSxPQUFPLEVBQUMsTUFBTSxFQUFFLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNqRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDL0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNyRCxPQUFPLEtBQUssRUFBRSxNQUFNLElBQUksQ0FBQzs7Ozs7O01BRW5CLEVBQUUsR0FBRyxjQUFjOztNQUNuQixHQUFHLEdBQUcsbUJBQW1COztNQUN6QixHQUFHLEdBQUcsUUFBUTs7TUFDZCxLQUFLLEdBQUcsRUFBRTs7TUFDVixLQUFLLEdBQUcsR0FBRzs7TUFDWCxTQUFTLEdBQUcsR0FBRzs7Ozs7O0FBV3JCLE1BQU0sT0FBTyxjQUFjOzs7Ozs7O0lBUXZCLFlBQ1ksRUFBYSxFQUNiLEdBQWUsRUFDZixFQUFnQixFQUNFLENBQU07UUFIeEIsT0FBRSxHQUFGLEVBQUUsQ0FBVztRQUNiLFFBQUcsR0FBSCxHQUFHLENBQVk7UUFDZixPQUFFLEdBQUYsRUFBRSxDQUFjO1FBQ0UsTUFBQyxHQUFELENBQUMsQ0FBSztRQVhwQyxXQUFNLEdBQVUsRUFBRSxDQUFDO1FBQ25CLFFBQUcsR0FBRyxDQUFDLENBQUM7UUFZSixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsNEJBQTRCLENBQUMsQ0FBQztJQUNqRCxDQUFDOzs7OztJQUVELEdBQUcsQ0FBQyxHQUFHLElBQUk7UUFDUCxJQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxJ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QUFDLE1BQU0sQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDakMsQ0FBQzs7Ozs7SUFHRCxLQUFLO1FBQ0QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQzdCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQy9ELENBQUM7Ozs7O0lBR0QsSUFBSTtRQUNBLElBQUksSUFBSSxDQUFDLElBQUksRUFBRTtZQUNYLElBQUksQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUMzQixZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3hCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1NBQ3BCO1FBQ0QsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ3BCLENBQUM7Ozs7O0lBR0QsT0FBTztRQUNILE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDdkIsQ0FBQzs7O1lBbEdKLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7OztZQXBCUSxTQUFTO1lBQ1QsVUFBVTtZQUNWLFlBQVk7NENBK0JaLE1BQU0sU0FBQyxRQUFROzs7OztJQVhwQixnQ0FBbUI7O0lBQ25CLDZCQUFROztJQUNSLDZCQUFTOztJQUNULCtCQUFjOztJQUNkLDhCQUFVOztJQUNWLDhCQUFhOztJQUdULDRCQUFxQjs7SUFDckIsNkJBQXVCOztJQUN2Qiw0QkFBd0I7O0lBQ3hCLDJCQUFnQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiAgQ29weXJpZ2h0IDIwMTgtcHJlc2VudCBPcGVuIE5ldHdvcmtpbmcgRm91bmRhdGlvblxuICpcbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqICBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiAgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuaW1wb3J0IHtJbmplY3QsIEluamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRm5TZXJ2aWNlIH0gZnJvbSAnLi4vdXRpbC9mbi5zZXJ2aWNlJztcbmltcG9ydCB7IExvZ1NlcnZpY2UgfSBmcm9tICcuLi9sb2cuc2VydmljZSc7XG5pbXBvcnQgeyBUaGVtZVNlcnZpY2UgfSBmcm9tICcuLi91dGlsL3RoZW1lLnNlcnZpY2UnO1xuaW1wb3J0ICogYXMgZDMgZnJvbSAnZDMnO1xuXG5jb25zdCBpZCA9ICdsb2FkaW5nLWFuaW0nO1xuY29uc3QgZGlyID0gJ2RhdGEvaW1nL2xvYWRpbmcvJztcbmNvbnN0IHBmeCA9ICcvbG9hZC0nO1xuY29uc3QgbkltZ3MgPSAxNjtcbmNvbnN0IHNwZWVkID0gMTAwO1xuY29uc3Qgd2FpdERlbGF5ID0gNTAwO1xuXG5cbi8qKlxuICogT05PUyBHVUkgLS0gTGF5ZXIgLS0gTG9hZGluZyBTZXJ2aWNlXG4gKlxuICogUHJvdmlkZXMgYSBtZWNoYW5pc20gdG8gc3RhcnQvc3RvcCB0aGUgbG9hZGluZyBhbmltYXRpb24sIGNlbnRlciBzY3JlZW4uXG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBMb2FkaW5nU2VydmljZSB7XG4gICAgaW1hZ2VzOiBhbnlbXSA9IFtdO1xuICAgIGlkeCA9IDA7XG4gICAgaW1nOiBhbnk7XG4gICAgdGhlbWU6IHN0cmluZztcbiAgICB0YXNrOiBhbnk7XG4gICAgd2FpdDogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgZnM6IEZuU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBsb2c6IExvZ1NlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgdHM6IFRoZW1lU2VydmljZSxcbiAgICAgICAgQEluamVjdCgnV2luZG93JykgcHJpdmF0ZSB3OiBhbnlcbiAgICApIHtcbiAgICAgICAgdGhpcy5wcmVsb2FkSW1hZ2VzKCk7XG4gICAgICAgIHRoaXMubG9nLmRlYnVnKCdMb2FkaW5nU2VydmljZSBjb25zdHJ1Y3RlZCcpO1xuICAgIH1cblxuICAgIGRiZyguLi5hcmdzKSB7XG4gICAgICAgIHRoaXMuZnMuZGVidWcodGhpcy5jb25zdHJ1Y3Rvci5uYW1lLCBhcmdzKTtcbiAgICB9XG5cbiAgICBwcmVsb2FkSW1hZ2VzKCkge1xuICAgICAgICBsZXQgaWR4OiBudW1iZXI7XG5cbiAgICAgICAgdGhpcy5kYmcoJ3ByZWxvYWQgaW1hZ2VzIHN0YXJ0Li4uJyk7XG4gICAgICAgIGZvciAoaWR4ID0gMTsgaWR4IDw9IG5JbWdzIDsgaWR4KyspIHtcbiAgICAgICAgICAgIHRoaXMuYWRkSW1nKCdsaWdodCcsIGlkeCk7XG4gICAgICAgICAgICB0aGlzLmFkZEltZygnZGFyaycsIGlkeCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kYmcoJ3ByZWxvYWQgaW1hZ2VzIERPTkUhJywgdGhpcy5pbWFnZXMpO1xuICAgIH1cblxuICAgIGFkZEltZyh0aGVtZTogc3RyaW5nLCBpZHg6IG51bWJlcikge1xuICAgICAgICBjb25zdCBpbWcgPSBuZXcgSW1hZ2UoKTtcbiAgICAgICAgaW1nLnNyYyA9IHRoaXMuZm5hbWUoaWR4LCB0aGVtZSk7XG4gICAgICAgIHRoaXMuaW1hZ2VzLnB1c2goaW1nKTtcbiAgICB9XG5cbiAgICBmbmFtZShpOiBudW1iZXIsIHRoZW1lOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgeiA9IGkgPiA5ID8gJycgOiAnMCc7XG4gICAgICAgIHJldHVybiBkaXIgKyB0aGVtZSArIHBmeCArIHogKyBpICsgJy5wbmcnO1xuICAgIH1cblxuICAgIG5leHRGcmFtZSgpIHtcbiAgICAgICAgdGhpcy5pZHggPSB0aGlzLmlkeCA9PT0gMTYgPyAxIDogdGhpcy5pZHggKyAxO1xuICAgICAgICB0aGlzLmltZy5hdHRyKCdzcmMnLCB0aGlzLmZuYW1lKHRoaXMuaWR4LCB0aGlzLnRoZW1lKSk7XG4gICAgfVxuXG4gICAgLy8gc3RhcnQgZGlzcGxheWluZyAnbG9hZGluZy4uLicgYW5pbWF0aW9uIChpZGVtcG90ZW50KVxuICAgIHN0YXJ0QW5pbSgpIHtcbiAgICAgICAgdGhpcy5kYmcoJ3N0YXJ0IEFOSU1BVElPTicpO1xuICAgICAgICB0aGlzLnRoZW1lID0gdGhpcy50cy5nZXRUaGVtZSgpO1xuICAgICAgICBsZXQgZGl2ID0gZDMuc2VsZWN0KCcjJyArIGlkKTtcbiAgICAgICAgaWYgKGRpdi5lbXB0eSgpKSB7XG4gICAgICAgICAgICBkaXYgPSBkMy5zZWxlY3QoJ2JvZHknKVxuICAgICAgICAgICAgICAgIC5hcHBlbmQoJ2RpdicpXG4gICAgICAgICAgICAgICAgLmF0dHIoJ2lkJywgaWQpO1xuICAgICAgICAgICAgdGhpcy5pbWcgPSBkaXZcbiAgICAgICAgICAgICAgICAuYXBwZW5kKCdpbWcnKVxuICAgICAgICAgICAgICAgIC5hdHRyKCdzcmMnLCB0aGlzLmZuYW1lKDEsIHRoaXMudGhlbWUpKTtcbiAgICAgICAgICAgIHRoaXMuaWR4ID0gMTtcbiAgICAgICAgICAgIHRoaXMudGFzayA9IHNldEludGVydmFsKCgpID0+IHRoaXMubmV4dEZyYW1lKCksIHNwZWVkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIHN0b3AgZGlzcGxheWluZyAnbG9hZGluZy4uLicgYW5pbWF0aW9uIChpZGVtcG90ZW50KVxuICAgIHN0b3BBbmltKCkge1xuICAgICAgICB0aGlzLmRiZygnKnN0b3AqIEFOSU1BVElPTicpO1xuICAgICAgICBpZiAodGhpcy50YXNrKSB7XG4gICAgICAgICAgICBjbGVhckludGVydmFsKHRoaXMudGFzayk7XG4gICAgICAgICAgICB0aGlzLnRhc2sgPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGQzLnNlbGVjdCgnIycgKyBpZCkucmVtb3ZlKCk7XG4gICAgfVxuXG4gICAgLy8gc2NoZWR1bGUgZnVuY3Rpb24gdG8gc3RhcnQgYW5pbWF0aW9uIGluIHRoZSBmdXR1cmVcbiAgICBzdGFydCgpIHtcbiAgICAgICAgdGhpcy5kYmcoJ3N0YXJ0IChzY2hlZHVsZSknKTtcbiAgICAgICAgdGhpcy53YWl0ID0gdGhpcy53LnNldFRpbWVvdXQodGhpcy5zdGFydEFuaW0oKSwgd2FpdERlbGF5KTtcbiAgICB9XG5cbiAgICAvLyBjYW5jZWwgZnV0dXJlIHN0YXJ0LCBpZiBhbnk7IHN0b3AgdGhlIGFuaW1hdGlvblxuICAgIHN0b3AoKSB7XG4gICAgICAgIGlmICh0aGlzLndhaXQpIHtcbiAgICAgICAgICAgIHRoaXMuZGJnKCdzdGFydCBDQU5DRUxFRCcpO1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMud2FpdCk7XG4gICAgICAgICAgICB0aGlzLndhaXQgPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc3RvcEFuaW0oKTtcbiAgICB9XG5cbiAgICAvLyByZXR1cm4gdHJ1ZSBpZiBzdGFydCgpIGhhcyBiZWVuIGNhbGxlZCBidXQgbm90IHN0b3AoKVxuICAgIHdhaXRpbmcoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAhIXRoaXMud2FpdDtcbiAgICB9XG5cblxufVxuIl19